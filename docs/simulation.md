# Simulation Guide (cocotb)

This document describes how to run the cocotb-based simulation for the Q1.15 moving‑average FIR, how parameters are passed, and how results and coverage are produced.

Primary components:
- Testbench: [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py)
- Makefile: [sim/cocotb/Makefile](sim/cocotb/Makefile)
- Golden model: [sim/golden/fir_model.py](sim/golden/fir_model.py)
- Driver agent: [agents/sim.py](agents/sim.py)

## Prerequisites

- Python 3.8+
- Verilator or Icarus Verilog
- Python dependencies from [requirements.txt](requirements.txt)

Install deps:
```bash
python -m pip install --upgrade pip
pip install -r requirements.txt
```

## How the cocotb flow is assembled

- The Makefile sets:
  - TOPLEVEL := fir8
  - MODULE := test_fir8
  - SIM := verilator (default)
  - Parameters ROUND, SAT, PIPELINE, TAPS default to numeric values (1, 1, 0, 8)
- For Verilator, parameters are passed via `-G` flags; for Icarus, via `-P` flags.
- The Python path is set to the repo root so the testbench can import the golden model.

Files:
- DUT core (sim): [src/rtl/fir8.v](src/rtl/fir8.v)
- Makefile: [sim/cocotb/Makefile](sim/cocotb/Makefile)
- Testbench: [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py)
- Golden model: [sim/golden/fir_model.py](sim/golden/fir_model.py)

## Running simulation with the agent

The simulation agent configures environment variables and invokes the cocotb Makefile.

Help:
```bash
python agents/sim.py --help
```

Typical runs:
```bash
# Verilator, TOPLEVEL=fir8 to match the Makefile
python agents/sim.py --sim verilator --top fir8 --taps 8 --pipeline 0

# Icarus, 16 taps, pipelined
python agents/sim.py --sim icarus --top fir8 --taps 16 --pipeline 1
```

Notes and caveats:
- The Makefile sets `TOPLEVEL := fir8`. Keep `--top fir8` when using the agent.
- Parameter vars consumed by cocotb/tests are numeric and case‑sensitive:
  - TAPS ∈ {4,8,16,32}
  - PIPELINE ∈ {0,1}
  - ROUND ∈ {0,1} (1=round, 0=truncate)
  - SAT ∈ {0,1} (1=saturate, 0=wrap)
- The agent also supports `--variant` to load parameters from a YAML using [common/config.py](common/config.py). That loader expects a “flat” schema per‑variant with keys `taps`, `pipeline`, `round`, `sat`. The repository’s synthesis-oriented [configs/variants.yaml](configs/variants.yaml) uses an uppercase nested `params` map not compatible with the flat schema. Prefer explicit `--taps/--pipeline/--round/--sat` for this repo, or supply a separate flat YAML if you want variant lookups via `--variant`.

Examples of explicit overrides:
```bash
# Round + saturate explicitly
python agents/sim.py --top fir8 --taps 8 --pipeline 0 --round round --sat saturate

# Truncate + wrap
python agents/sim.py --top fir8 --taps 8 --pipeline 0 --round truncate --sat wrap
```

## Direct Makefile invocation (optional)

You can run the Makefile directly without the agent:
```bash
# Defaults: SIM=verilator, TOPLEVEL=fir8, MODULE=test_fir8
make -C sim/cocotb

# Change simulator
make -C sim/cocotb SIM=icarus

# Change parameters
make -C sim/cocotb SIM=verilator TAPS=16 PIPELINE=1 ROUND=1 SAT=1
```

Makefile: [sim/cocotb/Makefile](sim/cocotb/Makefile)

## Testbench design overview

Testbench: [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py)

Stimulus types exercised:
- impulse
- step
- random
- alt (alternating extremes)
- ramp (symmetric)
- edge (extreme values stressing rounding/saturation)
- valid_gap (conditionally, when an `in_valid` alias exists)

Latency handling:
- The golden model emits valid once the window is full (i ≥ TAPS−1).
- The DUT adds a fixed latency of (1 + PIPELINE) cycles.
- The checker offsets expected streams by this latency.

Handshake:
- The core exposes `valid_in`/`ready_in`/`valid_out`. In this phase, `ready_in` is always 1.
- Some environments may expose `in_valid` in addition to `valid_in`. The testbench adapts and will drive either if present.

Scoreboarding:
- Expected results are computed via the golden model [sim/golden/fir_model.py](sim/golden/fir_model.py).
- Results are compared cycle‑by‑cycle when `valid_out` is asserted.

## Coverage

- The testbench uses `cocotb-coverage` to record coverage across stimulus types and current parameterization.
- Coverage is exported near the repo root `build/` directory as:
  - `build/coverage_{TAPS}_{PIPELINE}_{ROUND}_{SAT}.yml`
- A coverage threshold of ≥ 95% is enforced; the `test_99_coverage_and_export` test asserts this.

Artifacts:
- Coverage YAML: generated by [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py)
- Build/log directories: created by the cocotb flow and simulator

## Environment variables and mapping

- The agent [agents/sim.py](agents/sim.py) maps CLI flags to environment:
  - MODULE → MODULE (default: `test_fir8`)
  - TOPLEVEL → TOPLEVEL (keep `fir8` to align with the Makefile)
  - SIM → SIM (`verilator` or `icarus`)
  - TAPS/PIPELINE/ROUND/SAT → used by both simulator parameterization and the testbench
- The testbench reads `TAPS`, `PIPELINE`, `ROUND`, `SAT` from the environment and configures bins/expectations accordingly.

## Troubleshooting

- If the agent reports “Makefile not found,” check the default path or pass `--makefile sim/cocotb/Makefile`.
- For simulator‑specific issues, try switching SIM (e.g., Verilator ↔ Icarus).
- For coverage failures, set `LOG_LEVEL=DEBUG` and re‑run to see mismatch logs.
- Validate your environment vars are numeric for the Makefile (ROUND/SAT/PIPELINE/TAPS).

Related docs:
- cocotb integration details: [docs/cocotb_integration.md](docs/cocotb_integration.md)
- General troubleshooting: [docs/troubleshooting.md](docs/troubleshooting.md)