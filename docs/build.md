# Build System Overview

This project separates simulation, synthesis/PnR, and reporting into focused entry points while maintaining predictable artifact locations and CI automation.

Key components:
- Simulation Makefile (cocotb): [sim/cocotb/Makefile](sim/cocotb/Makefile)
- Synthesis agent (per‑variant orchestration): [agents/synth.py](agents/synth.py)
- Report generation and parsing: [scripts/mk_phase1_report.py](scripts/mk_phase1_report.py), [scripts/parse_nextpnr_report.py](scripts/parse_nextpnr_report.py)
- CI workflow: [.github/workflows/ci.yml](.github/workflows/ci.yml)

Artifacts and temporary files are written under:
- `build/` — per‑variant synthesis outputs and simulation build artifacts
- `artifacts/` — consolidated CSVs and reports

## Simulation build (cocotb)

The cocotb flow is Makefile‑driven and parameterized via environment variables. Defaults target the FIR core with TOPLEVEL=fir8.

Primary files:
- Makefile: [sim/cocotb/Makefile](sim/cocotb/Makefile)
- Testbench: [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py)
- DUT core: [src/rtl/fir8.v](src/rtl/fir8.v)

Typical usage:
```bash
# Run with defaults (SIM=verilator, TOPLEVEL=fir8)
make -C sim/cocotb

# Change simulator
make -C sim/cocotb SIM=icarus

# Change parameters (numeric)
make -C sim/cocotb SIM=verilator TAPS=16 PIPELINE=1 ROUND=1 SAT=1
```

Artifacts:
- cocotb build directories (simulator‑specific) under `sim/cocotb/` or near repo root
- Coverage YAML exported to `build/coverage_{TAPS}_{PIPELINE}_{ROUND}_{SAT}.yml` (see [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py))

More details: [docs/simulation.md](docs/simulation.md), [docs/cocotb_integration.md](docs/cocotb_integration.md)

## Synthesis/PnR build

The synthesis agent generates per‑variant Yosys scripts, invokes nextpnr‑ice40, packs bitstreams, and parses reports.

Entry point: [agents/synth.py](agents/synth.py)

Usage:
```bash
# Help
python agents/synth.py --help

# Build all variants from configs/variants.yaml
python agents/synth.py

# Build a subset
python agents/synth.py --only baseline8,pipelined8
```

Per‑variant outputs (under `build/<variant>/`):
- `run.ys` (auto‑generated Yosys script)
- `fir8_top.json`, `fir8_top_netlist.v`, `yosys_stat.json`
- `nextpnr.log`, `icetime.log`, `fir8_top.asc`, `fir8_top.bin`
- `meta.json`, `summary.csv`

Aggregated artifacts (under `artifacts/`):
- `variants_summary.csv` (aggregated by [agents/synth.py](agents/synth.py))
- `report_phase1.md` (generated by [scripts/mk_phase1_report.py](scripts/mk_phase1_report.py))

More details: [docs/synthesis.md](docs/synthesis.md)

## Artifacts directory structure

- `build/`
  - `<variant>/` — outputs for each configured variant
    - `fir8_top.json`, `fir8_top.asc`, `fir8_top.bin`
    - `yosys_stat.json`, `nextpnr.log`, `icetime.log`, `summary.csv`
    - `run.ys`, `meta.json`
- `artifacts/`
  - `variants_summary.csv` — consolidated table (timing/resources)
  - `report_phase1.md` — Phase 1 Markdown report

Simulation coverage:
- `build/coverage_{TAPS}_{PIPELINE}_{ROUND}_{SAT}.yml`

## Continuous Integration (CI)

Workflow definition: [.github/workflows/ci.yml](.github/workflows/ci.yml)

Typical CI stages:
- cocotb simulation matrix across key variants
- optional formal job (non‑blocking)
- synthesis/PnR for the same variant set
- aggregation of per‑variant summaries into a single CSV
- generation of a Phase 1 report

Outputs retained as workflow artifacts:
- `artifacts/variants_summary.csv`
- `artifacts/report_phase1.md`
- cocotb XML/coverage files (as configured)

## Cleaning up

Common cleanup patterns:
- Remove a single variant’s build directory: `rm -rf build/<variant>`
- Remove all build outputs: `rm -rf build/ artifacts/`
- Simulator‑specific intermediates (e.g., Verilator obj_dir) reside under cocotb’s build paths and can be safely removed.

## Logging and diagnostics

- Set `LOG_LEVEL=DEBUG` to increase verbosity for agents and scripts:
  - Agents: [agents/synth.py](agents/synth.py)
  - Parsers/reports: [scripts/parse_nextpnr_report.py](scripts/parse_nextpnr_report.py), [scripts/mk_phase1_report.py](scripts/mk_phase1_report.py)
- Central logging utilities: [common/logging.py](common/logging.py)

## Related documentation

- Simulation: [docs/simulation.md](docs/simulation.md)
- Synthesis: [docs/synthesis.md](docs/synthesis.md)
- Troubleshooting: [docs/troubleshooting.md](docs/troubleshooting.md)