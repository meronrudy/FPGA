# Fixed-Point Arithmetic and Latency (Q1.15)

This project implements a parameterized moving-average FIR in signed Q1.15 fixed-point format, supporting:
- TAPS ∈ {4, 8, 16, 32} (power-of-two)
- PIPELINE ∈ {0, 1}
- ROUND ∈ {0, 1}
- SAT ∈ {0, 1}

The core module is [src/rtl/fir8.v](src/rtl/fir8.v), with a synthesizable top [src/rtl/fir8_top.v](src/rtl/fir8_top.v).

## Q1.15 Format

- 16-bit signed fixed-point: 1 sign bit, 15 fractional bits.
- Numeric range:
  - Minimum: -1.0 → -32768 (0x8000)
  - Maximum: 0.999969482421875 → 32767 (0x7FFF)
- Arithmetic:
  - Addition/subtraction: 16-bit signed, with internal growth for accumulations.
  - Saturation (SAT=1): output clamped to [-32768, 32767]
  - Wrap (SAT=0): lower 16 bits retained (two’s complement wrap)

## Moving Average

Let TAPS be the number of taps (power-of-two). Define:
- SHIFT = log2(TAPS) = $clog2(TAPS) in RTL
- Window sum includes the current sample and previous (TAPS-1) samples.

Average is computed as:
- avg = (sum + bias) >>> SHIFT

Rounding behavior:
- When ROUND=1 (round-to-nearest, symmetric):
  - bias = +2^(SHIFT-1) if sum >= 0
  - bias = -2^(SHIFT-1) if sum < 0
- When ROUND=0:
  - bias = 0 (truncate, i.e., arithmetic right shift)

After averaging, output is either:
- Saturated to Q1.15 range if SAT=1
- Wrapped to 16-bit signed if SAT=0

These rules are mirrored in the Python golden model: [sim/golden/fir_model.py](sim/golden/fir_model.py).

## Validity and Latency

The output stream uses a simple valid-only protocol:
- Input: valid_in must be high to accept a sample. ready_in is always 1 (no backpressure).
- Output: valid_out asserts when an output sample is valid.

Window fill:
- The first time a full TAPS-sized window exists is at input index i = TAPS-1.

Latency:
- The core asserts valid_out one cycle after the window is full (baseline), plus an optional extra cycle if PIPELINE=1.

Formula:
- latency_cycles = (TAPS window fill) + 1 + PIPELINE

Meaning:
- valid_out starts at index i = (TAPS-1) + 1 + PIPELINE relative to the very first input sample.

Examples:
- TAPS=8, PIPELINE=0 → latency = 8 (7 to fill, +1) cycles from the first input sample to the first valid output.
- TAPS=8, PIPELINE=1 → latency = 9 cycles.
- TAPS=16, PIPELINE=0 → latency = 16 cycles.
- TAPS=32, PIPELINE=1 → latency = 33 cycles.

The cocotb tests align expected outputs by offsetting the golden model by (1 + PIPELINE) cycles once the window is full, see [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py).

## Parameter Validation

The RTL enforces safe configurations at elaboration-time:
- TAPS must be one of {4, 8, 16, 32}
- PIPELINE, ROUND, SAT must be 0 or 1

A synthesis-time error is emitted via `$error` if constraints are violated.

## Timing Target

- Base target for CI timing is 12 MHz (period = 83.333 ns).
- PnR/timing logs are parsed into per-variant CSVs with Fmax, slack vs 12 MHz, and resource utilization.
- See:
  - Place/route wrapper: [synth/ice40/nextpnr_ice40.sh](synth/ice40/nextpnr_ice40.sh)
  - Report parser: [scripts/parse_nextpnr_report.py](scripts/parse_nextpnr_report.py)
  - Aggregated summary: artifacts/variants_summary.csv
  - Phase 1 report: artifacts/report_phase1.md (generated by [scripts/mk_phase1_report.py](scripts/mk_phase1_report.py))

## Top-Level Integration (iCEBreaker)

- The top module [src/rtl/fir8_top.v](src/rtl/fir8_top.v) implements:
  - Synchronous POR
  - Heartbeat divider
  - 16-bit Fibonacci LFSR stimulus to exercise the FIR
  - Observable LED XOR path with FIR output MSB
- Parameters TAPS and PIPELINE can be forwarded to the FIR instance for hardware validation of different variants.

## Testing and Coverage

- Tests generate sequences (impulse, step, random, alternating-sign, ramp) with at least 4*TAPS samples.
- Coverage points include stimulus_type, taps, round, sat, pipeline, with cross coverage of taps × pipeline.
- Each test run must achieve ≥ 95% coverage (enforced), and coverage is exported to a YAML in build/.

See [sim/cocotb/test_fir8.py](sim/cocotb/test_fir8.py) and [sim/cocotb/Makefile](sim/cocotb/Makefile) for invocation details.
